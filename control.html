<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rS manager</title>
    <link rel="icon" href="favicon_C.png">
    <style>
        /* bodyタグ: ページ全体の基本的な設定です */
        body {
            /* 文字のフォントを指定します */
            font-family: sans-serif;
            /* 中身を中央揃えにします */
            text-align: center;
            /* ページの端から少し内側に余白を設けます */
            padding: 1em;
        }
        /* ▼▼▼▼▼ パスワード画面用のCSSを追加 ▼▼▼▼▼ */
        /* パスワード入力フォームのコンテナ */
        #password-prompt {
            /* 上からの余白を大きく取ります */
            margin-top: 200px;
        }
        /* パスワード入力欄 */
        #password-input {
            /* 文字の大きさを指定 */
            font-size: 18px;
            /* 内側の余白を指定 */
            padding: 10px;
            /* 横幅を指定 */
            width: 200px;
        }
        /* 送信ボタン */
        #password-submit {
            /* 文字の大きさを指定 */
            font-size: 18px;
            /* 内側の余白を指定 */
            padding: 10px 20px;
        }

        /* 記号ボタンを囲むdivタグ用の設定です */
        #symbol-buttons {
            /* Flexboxというレイアウト方法を使うことを宣言します */
            display: flex;
            /* 中身のアイテム（ボタン）を水平方向の中央に配置します */
            justify-content: center;
        }

        /* idがsymbol-buttonsの中にあるbuttonタグにだけ適用される設定です */
        #symbol-buttons button {
            /* 文字の大きさを50ピクセルにします */
            font-size: 50px;
            /* ボタンの横幅を100ピクセルにします */
            width: 100px;
            /* ボタンの高さを100ピクセルにします */
            height: 100px;
            /* ボタンの外側の余白を上下左右に15ピクセル設けます */
            margin: 15px;
            /* マウスカーソルを乗せたときに指の形になるようにします */
            cursor: pointer;
            /* ボタン内部の記号の色を設定 */
            color: #555;
            /* ボタンの枠線を設定します */
            border: 2px solid #ccc;
            /* 角を少し丸くします */
            border-radius: 5px;
            /* ボタンの背景色を白色にします */
            background-color: #fff;
            /* 色が変わるアニメーションを0.3秒かけて滑らかにします */
            transition: background-color 0.3s, border-color 0.3s;
            
            /* --- ここから下は、ボタンの中の記号を真ん中に配置するための設定です --- */
            /* ボタンの中身もFlexboxで配置します */
            display: flex;
            /* ボタンの中身を水平方向の中央に配置します */
            justify-content: center;
            /* ボタンの中身を垂直方向の中央に配置します */
            align-items: center;
            /* 文字の行の高さを調整してズレを防ぎます */
            line-height: 1;
            /* ボタンの内側の余白をなくします */
            padding: 0;
        }
        
        /* ▼▼▼▼▼ ここから下が、選択中のボタンのデザイン設定です ▼▼▼▼▼ */
        /* 'active-circle'クラスが付いたボタンのデザイン */
        #symbol-buttons button.active-circle {
            background-color: #e6ffed; /* 背景を淡い緑に */
            border-color: #28a745;   /* 枠線を緑に */
            color: #28a745;
        }
        /* 'active-triangle'クラスが付いたボタンのデザイン */
        #symbol-buttons button.active-triangle {
            background-color: #fff8e1; /* 背景を淡いオレンジに */
            border-color: #ffc107;   /* 枠線をオレンジに */
            color: #ffc107;
        }
        /* 'active-cross'クラスが付いたボタンのデザイン */
        #symbol-buttons button.active-cross {
            background-color: #ffebee; /* 背景を淡い赤に */
            border-color: #dc3545;   /* 枠線を赤に */
            color: #dc3545;
        }
        /* ▲▲▲▲▲ ここまで ▲▲▲▲▲ */
        /* ▼▼▼ このスタイルをまるごと追加 ▼▼▼ */
        /* 'pending'クラスが付いた、更新中のボタンのデザイン */
        #symbol-buttons button.pending {
            background-color: #e9ecef; /* 背景を薄い灰色に */
            border-color: #adb5bd;   /* 枠線を灰色に */
            color: #6c757d;        /* 記号の色を灰色に */
            cursor: wait;          /* カーソルを待機状態のアイコンに */
        }

        /* 備考欄のセクション用の設定です */
        #remarks-section {
            /* 上側に30ピクセルの余白を設けます */
            margin-top: 30px;
        }
        
        /* 備考の入力欄(input)用の設定です */
        #remarksInput {
            /* 横幅を親要素の80%にします */
            width: 80%;
            /* 内側の余白を10ピクセル設けます */
            padding: 10px;
            /* 文字の大きさを16ピクセルにします */
            font-size: 16px;
            /* 下側に10ピクセルの余白を設けます */
            margin-bottom: 10px;
        }

        /* 「備考を更新」ボタン用の設定です */
        #updateRemarksBtn {
            /* 横幅を親要素の60%にします */
            width: 60%;
            /* 内側の余白を上下に15ピクセル設けます */
            padding: 15px;
            /* 文字の大きさを18ピクセルにします */
            font-size: 18px;
            /* 背景色を青色にします */
            background-color: #007bff;
            /* 文字色を白色にします */
            color: white;
            /* 枠線をなくします */
            border: none;
            /* 角を少し丸くします */
            border-radius: 5px;
            /* 上のボタンとの間に余白を設けます */
            margin-top: 20px;
        }
        /* ▼▼▼ このスタイルをまるごと追加 ▼▼▼ */
        /* 'pending-remarks'クラスが付いた、更新中のボタンのデザイン */
        .pending-remarks {
            background-color: #adb5bd; /* 背景を灰色に */
            cursor: wait;          /* カーソルを待機状態のアイコンに */
        }
        /* 「入力欄をクリア」ボタン用の設定を追加 */
        #clearRemarksBtn {
            /* 横幅を親要素の80%にします */
            width: 60%;
            /* 内側の余白を少し小さめにします */
            padding: 1px;
            /* 文字の大きさを16ピクセルにします */
            font-size: 16px;
            /* 文字色を灰色にします */
            color: #555;
            /* 背景色を白色にします */
            background-color: #fff;
            /* 枠線をなくします */
            border: none;
            /* 上のボタンとの間に余白を設けます */
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="password-prompt">
        <h2>roomStatus manager</h2>
        <input type="password" id="password-input" placeholder="PASSWORD">
        <button id="password-submit">送信</button>
    </div>
   <main id="main-content" style="display: none;">
    <h1>roomStatus</h1>
    <div id="symbol-buttons">
        <button id="circleBtn">○</button>
        <button id="triangleBtn">△</button>
        <button id="crossBtn">×</button>
    </div>

    <div id="remarks-section">
        <h2>備考</h2>
        <input type="text" id="remarksInput" placeholder="例：ミーティング">
        <button id="updateRemarksBtn">更新</button>
        <button id="clearRemarksBtn">クリア</button>
    </div>
       </main>

<script type="module">
        // --- ここから下がパスワード認証の処理です ---
    　　// ▼▼▼ この行を追加 ▼▼▼
        // 空のまま送信ボタンが押された回数を数えるカウンター
        let emptyClickCount = 0;
        const CORRECT_PASSWORD = 'hiroya168';
        const passwordPrompt = document.getElementById('password-prompt');
        const mainContent = document.getElementById('main-content');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');

// ▼▼▼ この関数をまるごと差し替え ▼▼▼
        // パスワード送信ボタンがクリックされたときの処理
        passwordSubmit.onclick = () => {
            // 1. 正しいパスワードが入力された場合（通常ルート）
            if (passwordInput.value === CORRECT_PASSWORD) {
                // 認証成功の処理
                passwordPrompt.style.display = 'none';
                mainContent.style.display = 'block';
                return; // 処理をここで終了
            }

            // 2. 入力欄が空の場合（隠しコマンドルート）
            if (passwordInput.value === '') {
                // カウンターを1増やす
                emptyClickCount++;
                // もしカウンターが3になったら
                if (emptyClickCount === 3) {
                    // 認証成功の処理
                    passwordPrompt.style.display = 'none';
                    mainContent.style.display = 'block';
                }
                // 3回未満の場合は、何もせず次のクリックを待つ
                return; 
            }

            // 3. 上記のいずれでもない場合（間違ったパスワードが入力された場合）
            alert('パスワードが違います。');
            passwordInput.value = '';
            // カウンターをリセットする
            emptyClickCount = 0;
        };
    　　// ▼▼▼ この処理をまるごと追加 ▼▼▼
        // パスワード入力欄に何か文字が入力されたら、カウンターをリセットする
        passwordInput.oninput = () => {
            emptyClickCount = 0;
        };

        // --- ここから下がFirebaseの基本設定です ---
        const firebaseConfig = {
            apiKey: "AIzaSyApeciQMRZp47i1S5I28eUDGCwUIJx46o4",
            authDomain: "roomstatus-7b0c4.firebaseapp.com",
            databaseURL: "https://roomstatus-7b0c4-default-rtdb.firebaseio.com",
            projectId: "roomstatus-7b0c4",
            storageBucket: "roomstatus-7b0c4.firebasestorage.app",
            messagingSenderId: "355762487600",
            appId: "1:355762487600:web:c27907db8d4c8de18608f5",
            measurementId: "G-NRH5D6E3G0"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statusRef = ref(db, 'room/status');
        const ackRef = ref(db, 'room/ack');
        let waitingForAckId = null;

        // --- ここから下がHTML要素の取得です ---
        const circleBtn = document.getElementById('circleBtn');
        const triangleBtn = document.getElementById('triangleBtn');
        const crossBtn = document.getElementById('crossBtn');
        const remarksInput = document.getElementById('remarksInput');
        const updateRemarksBtn = document.getElementById('updateRemarksBtn');
        const clearRemarksBtn = document.getElementById('clearRemarksBtn');

        // --- ここからがボタンがクリックされたときの処理です ---
        
        // 記号ボタンが押されたときに行う処理
        const updateSymbol = (clickedBtn, newSymbol) => {
            [circleBtn, triangleBtn, crossBtn].forEach(btn => btn.classList.remove('pending'));
            clickedBtn.classList.add('pending');
            const updateId = Date.now();
            waitingForAckId = updateId;
            set(statusRef, { symbol: newSymbol, text: '', id: updateId });
        };

        circleBtn.onclick = () => updateSymbol(circleBtn, '○');
        triangleBtn.onclick = () => updateSymbol(triangleBtn, '△');
        crossBtn.onclick = () => updateSymbol(crossBtn, '×');
        
        // 「備考を更新」ボタンがクリックされたときの処理
        updateRemarksBtn.onclick = async () => {
            updateRemarksBtn.classList.add('pending-remarks');
            const newText = remarksInput.value;
            const snapshot = await get(statusRef);
            const currentSymbol = snapshot.val()?.symbol || '○';
            const updateId = Date.now();
            waitingForAckId = updateId;
            set(statusRef, { symbol: currentSymbol, text: newText, id: updateId });
        };

        // 「入力欄をクリア」ボタンがクリックされたときの処理
        clearRemarksBtn.onclick = async () => {
            clearRemarksBtn.classList.add('pending-remarks');
            const snapshot = await get(statusRef);
            const currentSymbol = snapshot.val()?.symbol || '○';
            const updateId = Date.now();
            waitingForAckId = updateId;
            set(statusRef, { symbol: currentSymbol, text: '', id: updateId });
            remarksInput.value = '';
        };

        // --- ここからがデータベースを監視する処理です ---

        // 1. 状態(status)を監視して、ボタンのアクティブ色を切り替える処理
        onValue(statusRef, (snapshot) => {
            const currentSymbol = snapshot.val()?.symbol;
            circleBtn.classList.remove('active-circle');
            triangleBtn.classList.remove('active-triangle');
            crossBtn.classList.remove('active-cross');

            if (currentSymbol === '○') {
                circleBtn.classList.add('active-circle');
            } else if (currentSymbol === '△') {
                triangleBtn.classList.add('active-triangle');
            } else if (currentSymbol === '×') {
                crossBtn.classList.add('active-cross');
            }
        });

        // 2. 更新完了通知(ack)を監視して、ボタンの「更新中」状態を解除する処理
        onValue(ackRef, (snapshot) => {
            const ackId = snapshot.val()?.id;
            
            if (ackId && ackId === waitingForAckId) {
                // すべての記号ボタンから「更新中」の外観を解除
                [circleBtn, triangleBtn, crossBtn].forEach(btn => btn.classList.remove('pending'));
                
                // 備考ボタンからも「更新中」の外観を解除
                updateRemarksBtn.classList.remove('pending-remarks');
                clearRemarksBtn.classList.remove('pending-remarks');

                // 待機状態を解除
                waitingForAckId = null;
                console.log('Acknowledgement received for ID:', ackId);
            }
        });
    </script>
</body>
</html>
